@{
    ViewData["Title"] = "Dashboard";
    var topSourceIps = (ViewBag.TopSourceIps as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var topProtocols = (ViewBag.TopProtocols as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var topDeviceTypes = (ViewBag.TopDeviceTypes as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var topEventTypes = (ViewBag.TopEventTypes as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var topDestIps = (ViewBag.TopDestIps as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var recentNetworkLogs = (ViewBag.RecentNetworkLogs as IEnumerable<RouterDetector.Models.Networklogs>)?.ToList() ?? new List<RouterDetector.Models.Networklogs>();
    var recentDetectionLogs = (ViewBag.RecentDetectionLogs as IEnumerable<RouterDetector.Models.Detectionlogs>)?.ToList() ?? new List<RouterDetector.Models.Detectionlogs>();
    var malwareByType = (ViewBag.MalwareByType as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var threatsBySeverity = (ViewBag.ThreatsBySeverity as IEnumerable<dynamic>)?.ToList() ?? new List<dynamic>();
    var recentMalwareEvents = (ViewBag.RecentMalwareEvents as IEnumerable<RouterDetector.Models.Detectionlogs>)?.ToList() ?? new List<RouterDetector.Models.Detectionlogs>();
    bool hasNetworkLogs = (ViewBag.TotalNetworkLogs ?? 0) > 0;
    bool hasDetectionLogs = (ViewBag.TotalDetectionLogs ?? 0) > 0;
}
<h1 class="mb-4">Dashboard & Analytics</h1>
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fa-solid fa-network-wired fa-2x mb-2"></i>
                <h5 class="card-title mt-2">Total Network Logs</h5>
                <p class="display-6 fw-bold mb-0">@ViewBag.TotalNetworkLogs</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-success shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fa-solid fa-bug fa-2x mb-2"></i>
                <h5 class="card-title mt-2">Total Detection Logs</h5>
                <p class="display-6 fw-bold mb-0">@ViewBag.TotalDetectionLogs</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-info shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fa-solid fa-clock fa-2x mb-2"></i>
                <h5 class="card-title mt-2">Logs in Last 24h</h5>
                <p class="display-6 fw-bold mb-0" id="logsLast24h">@((hasNetworkLogs) ? "..." : "0")</p>
            </div>
        </div>
    </div>
</div>
@if (!hasNetworkLogs && !hasDetectionLogs)
{
    <div class="alert alert-info text-center mt-4">
        <h4>No logs or analytics to display yet.</h4>
        <p>Run the capture console to start collecting network and detection logs.</p>
    </div>
}
@if (hasNetworkLogs || hasDetectionLogs)
{
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card text-white bg-danger shadow-sm h-100">
            <div class="card-body text-center">
                <i class="fa-solid fa-shield-virus fa-2x mb-2"></i>
                <h5 class="card-title mt-2">Malware/Security Events</h5>
                <p class="display-6 fw-bold mb-0">@ViewBag.TotalMalwareEvents</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Threats by Type</h5>
                @if (malwareByType.Count == 0)
                {
                    <div class="text-muted text-center">No data available</div>
                }
                else
                {
                    <canvas id="malwareTypeChart" height="120"></canvas>
                }
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Threats by Severity</h5>
                @if (threatsBySeverity.Count == 0)
                {
                    <div class="text-muted text-center">No data available</div>
                }
                else
                {
                    <canvas id="threatSeverityChart" height="120"></canvas>
                }
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Network Logs by Protocol</h5>
                @if (topProtocols.Count == 0)
                {
                    <div class="text-muted text-center">No data available</div>
                }
                else
                {
                    <canvas id="protocolChart" height="180"></canvas>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Detection Logs by Device Type</h5>
                @if (topDeviceTypes.Count == 0)
                {
                    <div class="text-muted text-center">No data available</div>
                }
                else
                {
                    <canvas id="deviceTypeChart" height="180"></canvas>
                }
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Detection Logs by Event Type</h5>
                @if (topEventTypes.Count == 0)
                {
                    <div class="text-muted text-center">No data available</div>
                }
                else
                {
                    <canvas id="eventTypeChart" height="180"></canvas>
                }
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Network Logs by Destination IP</h5>
                <canvas id="destIpChart" height="180"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Top Source IPs</h5>
                <table class="table table-sm">
                    <thead><tr><th>IP</th><th>Count</th></tr></thead>
                    <tbody>
                    @if (topSourceIps != null)
                    {
                        foreach (var ip in topSourceIps)
                        {
                            <tr><td>@ip.Ip</td><td>@ip.Count</td></tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Top Protocols</h5>
                <table class="table table-sm">
                    <thead><tr><th>Protocol</th><th>Count</th></tr></thead>
                    <tbody>
                    @if (topProtocols != null)
                    {
                        foreach (var proto in topProtocols)
                        {
                            <tr><td>@proto.Protocol</td><td>@proto.Count</td></tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Recent Network Logs</h5>
                <table class="table table-sm">
                    <thead><tr><th>Time</th><th>Src IP</th><th>Dst IP</th><th>Protocol</th><th>Message</th></tr></thead>
                    <tbody>
                    @if (recentNetworkLogs != null)
                    {
                        foreach (var log in recentNetworkLogs)
                        {
                            <tr>
                                <td>@log.LogOccurrence?.ToString("g")</td>
                                <td>@log.SrcIp</td>
                                <td>@log.DstIp</td>
                                <td>@log.Protocol</td>
                                <td>@log.Message</td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Recent Detection Logs</h5>
                <table class="table table-sm">
                    <thead><tr><th>Time</th><th>Source IP</th><th>Device Type</th><th>Event Type</th><th>Severity</th></tr></thead>
                    <tbody>
                    @if (recentDetectionLogs != null)
                    {
                        foreach (var log in recentDetectionLogs)
                        {
                            <tr>
                                <td>@log.Timestamp.ToString("g")</td>
                                <td>@log.SourceIP</td>
                                <td>@log.DeviceType</td>
                                <td>@log.EventType</td>
                                <td>@log.Severty</td>
                            </tr>
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-12 mb-4">
        <div class="card bg-white shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Recent Malware/Security Events</h5>
                <table class="table table-sm">
                    <thead><tr><th>Time</th><th>Source IP</th><th>Event Type</th><th>Severity</th><th>Action</th><th>Notes</th></tr></thead>
                    <tbody>
                    @foreach (var log in recentMalwareEvents)
                    {
                        <tr>
                            <td>@log.Timestamp.ToString("g")</td>
                            <td>@log.SourceIP</td>
                            <td>@log.EventType</td>
                            <td>@log.Severty</td>
                            <td>@log.ActionTaken</td>
                            <td>@log.Notes</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
}
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Protocol Chart
        const protocolLabels = [@string.Join(",", topProtocols.Select(p => "'" + (p.Protocol ?? "Unknown") + "'"))];
        const protocolData = [@string.Join(",", topProtocols.Select(p => p.Count))];
        new Chart(document.getElementById('protocolChart'), {
            type: 'bar',
            data: {
                labels: protocolLabels,
                datasets: [{
                    label: 'Count',
                    data: protocolData,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        // Device Type Chart
        const deviceTypeLabels = [@string.Join(",", topDeviceTypes.Select(d => "'" + (d.DeviceType ?? "Unknown") + "'"))];
        const deviceTypeData = [@string.Join(",", topDeviceTypes.Select(d => d.Count))];
        new Chart(document.getElementById('deviceTypeChart'), {
            type: 'pie',
            data: {
                labels: deviceTypeLabels,
                datasets: [{
                    data: deviceTypeData,
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d']
                }]
            },
            options: { responsive: true }
        });
        // Event Type Chart
        const eventTypeLabels = [@string.Join(",", topEventTypes.Select(e => "'" + (e.EventType ?? "Unknown") + "'"))];
        const eventTypeData = [@string.Join(",", topEventTypes.Select(e => e.Count))];
        new Chart(document.getElementById('eventTypeChart'), {
            type: 'bar',
            data: {
                labels: eventTypeLabels,
                datasets: [{
                    label: 'Count',
                    data: eventTypeData,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        // Destination IP Chart
        const destIpLabels = [@string.Join(",", topDestIps.Select(d => "'" + (d.Ip ?? "Unknown") + "'"))];
        const destIpData = [@string.Join(",", topDestIps.Select(d => d.Count))];
        new Chart(document.getElementById('destIpChart'), {
            type: 'bar',
            data: {
                labels: destIpLabels,
                datasets: [{
                    label: 'Count',
                    data: destIpData,
                    backgroundColor: 'rgba(255, 206, 86, 0.7)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        // Malware/Threats by Type Chart
        const malwareTypeLabels = [@string.Join(",", malwareByType.Select(m => "'" + (m.EventType ?? "Unknown") + "'"))];
        const malwareTypeData = [@string.Join(",", malwareByType.Select(m => m.Count))];
        new Chart(document.getElementById('malwareTypeChart'), {
            type: 'bar',
            data: {
                labels: malwareTypeLabels,
                datasets: [{
                    label: 'Count',
                    data: malwareTypeData,
                    backgroundColor: 'rgba(220, 53, 69, 0.7)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
        // Threats by Severity Chart
        const threatSeverityLabels = [@string.Join(",", threatsBySeverity.Select(s => "'" + (s.Severty ?? "Unknown") + "'"))];
        const threatSeverityData = [@string.Join(",", threatsBySeverity.Select(s => s.Count))];
        new Chart(document.getElementById('threatSeverityChart'), {
            type: 'pie',
            data: {
                labels: threatSeverityLabels,
                datasets: [{
                    data: threatSeverityData,
                    backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#007bff', '#6c757d']
                }]
            },
            options: { responsive: true }
        });
        // Fetch logs in last 24h
        fetch('/api/TrafficLogs/network')
            .then(res => res.json())
            .then(data => {
                const now = new Date();
                const last24h = data.filter(l => l.logOccurrence && (now - new Date(l.logOccurrence)) < 24*60*60*1000);
                document.getElementById('logsLast24h').textContent = last24h.length;
            });
    </script>
} 